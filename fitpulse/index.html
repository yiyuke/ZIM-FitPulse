<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>FitPulse</title>

<!--
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ZIM Zapps
Progressive Web App (PWA) tool output from
https://zimjs.com/zapps/tool.html 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-->

<!-- ZIM PWA STEP 1 - MANIFEST -->
<link rel="manifest" href="manifest.json">

<!-- ZIM PWA STEP 2 - META -->
<meta name="apple-mobile-web-app-title" content="FitPulse">
<meta name="theme-color" content="#333333">
<meta name="msapplication-TileColor" content="#333333">

<meta name="viewport" content="width=device-width, user-scalable=no">
<link rel="apple-touch-icon" href="icons/icon_152.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="msapplication-TileImage" content="icons/icon_144.png">

<!-- should have faveicons - see link below -->
<!-- see https://www.favicon-generator.org/ -->

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="msapplication-starturl" content="./">

<!-- ZIM PWA STEP 3 - SERVICE WORKER -->
<script>
	window.addEventListener("DOMContentLoaded", function () {
		if (location.protocol === "https:" && "serviceWorker" in navigator) navigator.serviceWorker.register("./serviceworker.js");
	});
</script>


<script src="libraries/createjs.js"></script>
<script src="libraries/zim_min.js"></script>

<!-- zimjs.com - JavaScript Canvas Framework -->
<script type="module">
const assets = "icon.png";
const path = "assets/"

new Frame(FULL, null, null, light, dark, ready, assets, path);
function ready() {

	// ZIM PWA STEP 4 - ADD TO HOME SCREEN (A2HS)
	// NOTE: new PWA() works with ZIM Cat 04 or beyond
	// Message shows if only if running from mobile Browser
	// See https://zimjs.com/docs.html?item=PWA for more options
	// Will want to move this to bottom of app code

	new PWA();

    const container = new Container().center();

    // const logo = new Pic("icon.png")
    //     .scaleTo(S, 30, 50)
    //     .center(container)
    //     .drag();
    // Create balance indicator ring
    const ring = new Circle({
        radius: 100,
        borderColor: purple,
        borderWidth: 10,
        color: "transparent"
    }).center(container);

    // Add inner progress ring
    const progressRing = new Shape().addTo(container);
    
    // Add tilt display
    const tiltDisplay = new Label({
        text: "Deviation: 0°",
        size: 20,
        color: red,
    }).center(container)

    function setupTiltDetection() {
        console.log("Setting up tilt detection for both axes");
        
        // 添加计数相关变量
        let repCount = 0;
        
        // 创建合并了计数显示的按钮
        const countButton = new Button({
            label: "次数: 0",
            width: 150,
            height: 60,
            backgroundColor: "#4CAF50",
            rollBackgroundColor: "#388E3C",
            corner: 10,
            shadowColor: "rgba(0,0,0,0.3)",
            shadowBlur: 5,
            labelSize: 24,
            labelColor: white
        }).pos(0, -150, CENTER, CENTER, container);
        
        // 按钮点击事件
        countButton.on("click", function() {
            repCount++;
            // 使用setText方法而不是直接设置label属性
            countButton.text = `次数: ${repCount}`;

            // 按钮动画效果
            countButton.animate({
                props: {scale:1.1},
                time: 100,
                rewind: true
            });
            
            S.update();
        });
        
        // 创建一个独立的容器来放置重置按钮，避免事件冒泡
        const resetContainer = new Container().addTo(container);
        
        // 添加重置按钮
        const resetButton = new Button({
            label: "重置",
            width: 80,
            height: 40,
            backgroundColor: "#F44336",
            rollBackgroundColor: "#D32F2F",
            corner: 8,
            labelSize: 18
        }).pos(80, -150, RIGHT, CENTER, resetContainer);
        
        // 重置按钮点击事件
        resetButton.on("click", function(e) {
            // 阻止事件冒泡
            e.stopPropagation();
            
            repCount = 0;
            // 使用setText方法而不是直接设置label属性
            countButton.text = `次数: ${repCount}`;
            
            console.log("重置计数器为0");
            S.update();
        });
        
        // 监听设备方向变化
        window.addEventListener("deviceorientation", (event) => {
            // 获取旋转值
            const beta = event.beta || 0;  // x轴旋转 (-180 到 180)
            const gamma = event.gamma || 0; // y轴旋转 (-90 到 90)
            
            // 计算绝对值
            const absBeta = Math.abs(beta);
            const absGamma = Math.abs(gamma);
            
            // 计算总体倾斜度
            const totalDeviation = Math.sqrt(absBeta * absBeta + absGamma * absGamma);
            
            // 显示倾斜度
            tiltDisplay.text = `倾斜: ${totalDeviation.toFixed(1)}°\n前后: ${absBeta.toFixed(1)}°, 左右: ${absGamma.toFixed(1)}°`;
            
            // 更新环的颜色和大小
            if (totalDeviation > 20) {
                ring.borderColor = "#ff0000"; // 红色表示严重倾斜
                ring.scaleX = ring.scaleY = 0.7;
            } else if (totalDeviation > 10) {
                ring.borderColor = "#ff9800"; // 橙色表示中度倾斜
                ring.scaleX = ring.scaleY = 0.85;
            } else if (totalDeviation > 5) {
                ring.borderColor = "#FFEB3B"; // 黄色表示轻微倾斜
                ring.scaleX = ring.scaleY = 0.95;
            } else {
                ring.borderColor = "#4CAF50"; // 绿色表示水平
                ring.scaleX = ring.scaleY = 1;
            }

            // 绘制进度环
            const progress = Math.min(totalDeviation / 20, 1);
            progressRing.graphics.clear()
                .setStrokeStyle(5)
                .beginStroke(ring.borderColor)
                .arc(0, 0, 80, 0, Math.PI * 2 * progress);
            
            S.update();
        });
    }

    // 处理权限
    if (typeof DeviceOrientationEvent !== 'undefined' && 
        typeof DeviceOrientationEvent.requestPermission === 'function') {
        
        // 添加权限按钮
        const permissionButton = new Button({
            width: 200,
            height: 50,
            label: "开始训练",
            backgroundColor: blue,
            rollBackgroundColor: "#1976D2",
            corner: 10
        }).center(container);

        permissionButton.on("click", async () => {
            try {
                // 请求设备方向权限
                const orientationPermission = await DeviceOrientationEvent.requestPermission();
                
                // 请求设备运动权限（如果可用）
                let motionPermission = "granted";
                if (typeof DeviceMotionEvent !== 'undefined' && 
                    typeof DeviceMotionEvent.requestPermission === 'function') {
                    motionPermission = await DeviceMotionEvent.requestPermission();
                }
                
                if (orientationPermission === "granted" && motionPermission === "granted") {
                    setupTiltDetection();
                    permissionButton.removeFrom();
                }
            } catch (error) {
                console.error("Error requesting permission:", error);
            }
        });
    } else {
        setupTiltDetection();
    }

    S.update();
}
</script>

</head>
<body></body>
</html>