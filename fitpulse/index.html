<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>FitPulse</title>

<!--
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ZIM Zapps
Progressive Web App (PWA) tool output from
https://zimjs.com/zapps/tool.html 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-->

<!-- ZIM PWA STEP 1 - MANIFEST -->
<link rel="manifest" href="manifest.json">

<!-- ZIM PWA STEP 2 - META -->
<meta name="apple-mobile-web-app-title" content="FitPulse">
<meta name="theme-color" content="#333333">
<meta name="msapplication-TileColor" content="#333333">

<meta name="viewport" content="width=device-width, user-scalable=no">
<link rel="apple-touch-icon" href="icons/icon_152.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="msapplication-TileImage" content="icons/icon_144.png">

<!-- should have faveicons - see link below -->
<!-- see https://www.favicon-generator.org/ -->

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="msapplication-starturl" content="./">

<!-- ZIM PWA STEP 3 - SERVICE WORKER -->
<script>
	window.addEventListener("DOMContentLoaded", function () {
		if (location.protocol === "https:" && "serviceWorker" in navigator) navigator.serviceWorker.register("./serviceworker.js");
	});
</script>


<script src="libraries/createjs.js"></script>
<script src="libraries/zim_min.js"></script>

<!-- zimjs.com - JavaScript Canvas Framework -->
<script type="module">
const assets = "icon.png";
const path = "assets/"

new Frame(FULL, null, null, light, dark, ready, assets, path);
function ready() {
    new PWA();

    // Create app state
    const appState = {
        screen: "home", // home, game, results
        mode: "solo",   // solo, multiplayer
        duration: 30,   // 30, 60
        playerName: "Player1",
        repCount: 0,
        warnings: 0,
        avgTilt: 0,
        tiltReadings: []
    };

    // Main container for all screens
    //const mainContainer = new Container().center();
    
    // Create screens
    const homeScreen = new Container().center();
    const gameScreen = new Container().center().vis(false);
    const resultsScreen = new Container().center().vis(false);

    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // HOME SCREEN
    const logo = new Label({
        text: "FitPulse",
        size: 50,
        color: blue,
        bold: true
    }).loc(-100, -270, homeScreen);
    
    // Mode selection
    new Label({
        text: "Mode Selection",
        size: 24,
        color: dark
    }).loc(-100, -90, homeScreen);
    
    const modeRadio = new RadioButtons({
        size: 20,
        buttons: ["Solo", "Multiplayer"],
        vertical:false,
        selectedIndex: 0,
        spacing: 10,
        color: blue,
        backgroundColor: light
    }).loc(-100, -50, homeScreen)
    .on("change", function() {
        appState.mode = this.selectedIndex == 0 ? "solo" : "multiplayer";
    });
    
    // Duration selection
    new Label({
        text: "Duration",
        size: 24,
        color: dark
    }).loc(-100, -180, homeScreen);
    
    const durationRadio = new RadioButtons({
        size: 20,
        buttons: ["30s", "60s"],
        selectedIndex: 0,
        vertical:false,
        spacing: 10,
        color: blue,
        backgroundColor: light
    }).loc(-100, -140, homeScreen)
    .on("change", function() {
        appState.duration = this.selectedIndex == 0 ? 30 : 60;
    });
    
    // Player name
    new Label({
        text: "Player Name",
        size: 24,
        color: dark
    }).loc(-100, 0, homeScreen);
    
    const nameInput = new TextInput({
        placeholder:"Player1",
        width:200,
        height:40,
        backgroundColor:light,
        borderColor:blue,
        borderWidth:2,
        corner:5
    }).loc(-100, 40, homeScreen)
    .on("change", function() {
        appState.playerName = this.text || "Player1";
    });
    
    // Start button
    const startButton = new Button({
        label:"START",
        width:200,
        height:50,
        backgroundColor:blue,
        rollBackgroundColor:"#1976D2",
        corner:10
    }).loc(-100, 200, homeScreen)
    .on("click", function() {
        showScreen("game");
        startGame();
    });
    
    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
    // RESULTS SCREEN
    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    function showResultsScreen() {
        // Calculate average tilt
        if (appState.tiltReadings.length > 0) {
            appState.avgTilt = appState.tiltReadings.reduce((a, b) => a + b, 0) / appState.tiltReadings.length;
        }
        
        resultsScreen.removeAllChildren();
        
        new Label({
            text: appState.playerName,
            size: 40,
            color: blue,
            bold: true
        }).pos(0, -200, CENTER, CENTER, resultsScreen);
        
        new Label({
            text: `‚úÖ Reps: ${appState.repCount}`,
            size: 30,
            color: dark
        }).loc(-100, -50,resultsScreen);
        
        new Label({
            text: `üéØ Avg Tilt: ${appState.avgTilt.toFixed(1)}¬∞`,
            size: 30,
            color: dark
        }).loc(-100, -100,resultsScreen);
        
        new Label({
            text: `‚ö†Ô∏è Warnings: ${appState.warnings}`,
            size: 30,
            color: dark
        }).loc(-100, -150,resultsScreen);
        
        // Action buttons
        new Button({
            label:"RETRY",
            width:150,
            height:60,
            backgroundColor:blue,
            rollBackgroundColor:"#1976D2",
            corner:10
        }).loc(-160, 200,resultsScreen)
        .on("click", function() {
            resetGameState();
            showScreen("game");
            startGame();
        });
        
        new Button({
            label:"HOME",
            width:150,
            height:60,
            backgroundColor:"#4CAF50",
            rollBackgroundColor:"#388E3C",
            corner:10
        }).loc(20, 200, resultsScreen)
        .on("click", function() {
            resetGameState();
            showScreen("home");
        });
    }
    
    // Helper functions
    function showScreen(screenName) {
        appState.screen = screenName;
        homeScreen.vis(false);
        gameScreen.vis(false);
        resultsScreen.vis(false);
        
        if (screenName === "home") homeScreen.vis(true);
        else if (screenName === "game") gameScreen.vis(true);
        else if (screenName === "results") {
            showResultsScreen();
            resultsScreen.vis(true);
        }
        
        S.update();
    }
    
    function resetGameState() {
        appState.repCount = 0;
        appState.warnings = 0;
        appState.tiltReadings = [];
        appState.avgTilt = 0;
    }
    
    function startGame() {
        // Game initialization code will go here
        setupTiltDetection();
    }
    
    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // GAME SCREEN SETUP
    //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    // Tilt detection setup
    function setupTiltDetection() {
        // Clear game screen first
        gameScreen.removeAllChildren();
        
        // Add timer display
        const timerLabel = new Label({
            text: `${appState.duration}s`,
            size: 30,
            color: blue,
            bold: true
        }).loc(-100, -260, gameScreen);

        // Add rep counter display
        const repLabel = new Label({
            text: "Reps: 0",
            size: 30,
            color: blue,
            bold: true
        }).loc(0, -260, gameScreen);
        
        // Create tilt display
        const tiltDisplay = new Label({
            text: "Tilt: 0.0¬∞",
            size: 18,
            color: dark,
            align: CENTER
        }).centerReg().loc(4, 26, gameScreen).outline();
        
        // Create balance ring
        const ring = new Circle({
            radius: 100,
            color: null,
            borderColor: "#4CAF50", // Green for level
            borderWidth: 10
        }).centerReg(gameScreen).mov(null, 140).outline();
        
        // Create progress ring
        const progressRing = new Shape().centerReg(gameScreen).mov(null, 150);
        
        // Add manual rep counter button (from your original code)
        const countButton = new Button({
            label: "Count: 0",
            size: 20,
            width: 174,
            height: 60,
            backgroundColor: "#4CAF50",
            rollBackgroundColor: "#388E3C",
            corner: 10
        }).loc(-160, -200, gameScreen);
        
        // Button click event
        countButton.on("click", function() {
            appState.repCount++;
            countButton.text = `Count: ${appState.repCount}`;
            repLabel.text = `Reps: ${appState.repCount}`;

            // Button animation effect
            countButton.animate({
                props: {scale:1.1},
                time: 100,
                rewind: true
            });
            
            S.update();
        });
        
        // Add reset button
        const resetButton = new Button({
            label: "Reset",
            width: 130,
            height: 60,
            backgroundColor: "#F44336",
            rollBackgroundColor: "#D32F2F",
            corner: 8
        }).loc(32, -200, gameScreen);
        
        // Reset button click event
        resetButton.on("click", function(e) {
            e.stopPropagation();
            
            appState.repCount = 0;
            countButton.text = `Count: ${appState.repCount}`;
            repLabel.text = `Reps: ${appState.repCount}`;
            
            S.update();
        });
        
        // Variables for tilt detection
        let isInDownPosition = false;
        let warningActive = false;
        let dangerThreshold = 20; // Threshold for warning
        let failureThreshold = 25; // Threshold for failure
        
        // Timer functionality
        let timeRemaining = appState.duration;
        let timerInterval = setInterval(() => {
            timeRemaining--;
            timerLabel.text = `${timeRemaining}s`;
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                window.removeEventListener("deviceorientation", handleOrientation);
                showScreen("results");
            }
            
            S.update();
        }, 1000);
        
        // Device orientation handler
        function handleOrientation(event) {
            // Get rotation values
            const beta = event.beta || 0;  // x-axis rotation (-180 to 180)
            const gamma = event.gamma || 0; // y-axis rotation (-90 to 90)
            
            // Calculate absolute values
            const absBeta = Math.abs(beta);
            const absGamma = Math.abs(gamma);
            
            // Calculate total deviation
            const totalDeviation = Math.sqrt(absBeta * absBeta + absGamma * absGamma);
            
            // Store tilt reading for average calculation
            appState.tiltReadings.push(totalDeviation);
            
            // Display tilt
            tiltDisplay.text = `Tilt: ${totalDeviation.toFixed(1)}¬∞`;
            
            // Update ring color and size
            if (totalDeviation > failureThreshold) {
                ring.borderColor = "#ff0000"; // Red for severe tilt
                ring.scaleX = ring.scaleY = 0.7;
                
                if (!warningActive) {
                    warningActive = true;
                    appState.warnings++;
                    
                    // Vibrate if supported
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    
                    // Check for failure
                    if (appState.warnings > 3) {
                        // Game over due to excessive warnings
                        clearInterval(timerInterval);
                        window.removeEventListener("deviceorientation", handleOrientation);
                        showScreen("results");
                    }
                    
                    // Reset warning after 3 seconds
                    setTimeout(() => {
                        warningActive = false;
                    }, 3000);
                }
            } else if (totalDeviation > dangerThreshold) {
                ring.borderColor = "#ff9800"; // Orange for moderate tilt
                ring.scaleX = ring.scaleY = 0.85;
            } else if (totalDeviation > 5) {
                ring.borderColor = "#FFEB3B"; // Yellow for slight tilt
                ring.scaleX = ring.scaleY = 0.95;
            } else {
                ring.borderColor = "#4CAF50"; // Green for level
                ring.scaleX = ring.scaleY = 1;
            }

            // Draw progress ring
            const progress = Math.min(totalDeviation / 20, 1);
            progressRing.graphics.clear()
                .setStrokeStyle(5)
                .beginStroke(ring.borderColor)
                .arc(0, 0, 80, 0, Math.PI * 2 * progress);
            
            // Automatic rep counting based on tilt pattern
            // Detect downward movement (increasing beta)
            if (!isInDownPosition && absBeta > 40) {
                isInDownPosition = true;
            }
            // Detect upward movement (decreasing beta)
            else if (isInDownPosition && absBeta < 15) {
                isInDownPosition = false;
                // Count a rep
                appState.repCount++;
                repLabel.text = `Reps: ${appState.repCount}`;
                countButton.text = `Count: ${appState.repCount}`;
                
                // Provide feedback
                if (navigator.vibrate) {
                    navigator.vibrate(100);
                }
            }
            
            S.update();
        }
        
        // Request permission for device orientation
        if (typeof DeviceOrientationEvent !== 'undefined' && 
            typeof DeviceOrientationEvent.requestPermission === 'function') {
            // iOS 13+ requires permission
            DeviceOrientationEvent.requestPermission()
                .then(permissionState => {
                    if (permissionState === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                    }
                })
                .catch(console.error);
        } else {
            // Non iOS 13+ devices
            window.addEventListener('deviceorientation', handleOrientation);
        }
        
        // Add control buttons at the bottom
        const buttonContainer = new Container().loc(0, 200, gameScreen);
        
        // Add a back button to game screen
        new Button({
            label: "QUIT",
            width: 150,
            height: 60,
            backgroundColor: purple,
            rollBackgroundColor: "#d32f2f",
            corner: 5
        }).loc(-160, 0, buttonContainer)
        .on("click", function() {
            clearInterval(timerInterval);
            window.removeEventListener("deviceorientation", handleOrientation);
            resetGameState();
            showScreen("home");
        });
        
        // Add a finish button to end the game early
        new Button({
            label: "FINISH",
            width: 150,
            height: 60,
            backgroundColor: "#2196F3",
            rollBackgroundColor: "#1976D2",
            corner: 5
        }).loc(10, 0, buttonContainer)
        .on("click", function() {
            clearInterval(timerInterval);
            window.removeEventListener("deviceorientation", handleOrientation);
            showScreen("results");
        });
    }
    
    // Start with home screen
    showScreen("home");
}
</script>

</head>
<body></body>
</html>