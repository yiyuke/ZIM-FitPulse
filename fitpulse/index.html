<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>FitPulse</title>

<!--
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ZIM Zapps
Progressive Web App (PWA) tool output from
https://zimjs.com/zapps/tool.html 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-->

<!-- ZIM PWA STEP 1 - MANIFEST -->
<link rel="manifest" href="manifest.json">

<!-- ZIM PWA STEP 2 - META -->
<meta name="apple-mobile-web-app-title" content="FitPulse">
<meta name="theme-color" content="#333333">
<meta name="msapplication-TileColor" content="#333333">

<meta name="viewport" content="width=device-width, user-scalable=no">
<link rel="apple-touch-icon" href="icons/icon_152.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="msapplication-TileImage" content="icons/icon_144.png">

<!-- should have faveicons - see link below -->
<!-- see https://www.favicon-generator.org/ -->

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="msapplication-starturl" content="./">

<!-- ZIM PWA STEP 3 - SERVICE WORKER -->
<script>
	window.addEventListener("DOMContentLoaded", function () {
		if (location.protocol === "https:" && "serviceWorker" in navigator) navigator.serviceWorker.register("./serviceworker.js");
	});
</script>


<script src="libraries/createjs.js"></script>
<script src="libraries/zim_min.js"></script>

<!-- zimjs.com - JavaScript Canvas Framework -->
<script type="module">
const assets = "icon.png";
const path = "assets/"

new Frame(FULL, null, null, light, dark, ready, assets, path);
function ready() {

	// ZIM PWA STEP 4 - ADD TO HOME SCREEN (A2HS)
	// NOTE: new PWA() works with ZIM Cat 04 or beyond
	// Message shows if only if running from mobile Browser
	// See https://zimjs.com/docs.html?item=PWA for more options
	// Will want to move this to bottom of app code

	new PWA();

    const container = new Container().center();

    // const logo = new Pic("icon.png")
    //     .scaleTo(S, 30, 50)
    //     .center(container)
    //     .drag();
    // Create balance indicator ring
    const ring = new Circle({
        radius: 100,
        borderColor: purple,
        borderWidth: 10,
        color: "transparent"
    }).center(container);

    // Add inner progress ring
    const progressRing = new Shape().addTo(container);
    
    // Add tilt display
    const tiltDisplay = new Label({
        text: "Deviation: 0°",
        size: 20,
        color: red,
    }).center(container)

    function setupTiltDetection() {
        console.log("Setting up tilt detection for both axes");
        
        // 添加计数相关变量
        let repCount = 0;
        let isLowPosition = false;
        let isHighPosition = false;
        const LOW_THRESHOLD = -3;  // 降低下蹲阈值，使其更容易触发
        const HIGH_THRESHOLD = 3;  // 降低站立阈值，使其更容易触发
        
        // 添加调试显示
        const debugDisplay = new Label({
            text: "加速度: 0",
            size: 20,
            color: white,
            backgroundColor: "#333333",
            padding: 10,
            corner: 5
        }).pos(0, -120, LEFT, TOP, container);
        
        // 添加计数显示
        const repCountDisplay = new Label({
            text: "次数: 0",
            size: 30,
            color: white,
            backgroundColor: "#333333",
            padding: 10,
            corner: 5
        }).pos(0, 60, LEFT, TOP, container);
        
        // 监听设备方向变化
        window.addEventListener("deviceorientation", (event) => {
            // 获取旋转值
            const beta = event.beta || 0;  // x轴旋转 (-180 到 180)
            const gamma = event.gamma || 0; // y轴旋转 (-90 到 90)
            
            // 计算绝对值
            const absBeta = Math.abs(beta);
            const absGamma = Math.abs(gamma);
            
            // 计算总体倾斜度
            const totalDeviation = Math.sqrt(absBeta * absBeta + absGamma * absGamma);
            
            // 显示倾斜度
            tiltDisplay.text = `倾斜: ${totalDeviation.toFixed(1)}°\n前后: ${absBeta.toFixed(1)}°, 左右: ${absGamma.toFixed(1)}°`;
            
            // 更新环的颜色和大小
            if (totalDeviation > 20) {
                ring.borderColor = "#ff0000"; // 红色表示严重倾斜
                ring.scaleX = ring.scaleY = 0.7;
            } else if (totalDeviation > 10) {
                ring.borderColor = "#ff9800"; // 橙色表示中度倾斜
                ring.scaleX = ring.scaleY = 0.85;
            } else if (totalDeviation > 5) {
                ring.borderColor = "#FFEB3B"; // 黄色表示轻微倾斜
                ring.scaleX = ring.scaleY = 0.95;
            } else {
                ring.borderColor = "#4CAF50"; // 绿色表示水平
                ring.scaleX = ring.scaleY = 1;
            }

            // 绘制进度环
            const progress = Math.min(totalDeviation / 20, 1);
            progressRing.graphics.clear()
                .setStrokeStyle(5)
                .beginStroke(ring.borderColor)
                .arc(0, 0, 80, 0, Math.PI * 2 * progress);
            
            S.update();
        });
        
        // 监听设备加速度变化来检测上下运动
        window.addEventListener("devicemotion", (event) => {
            // 获取加速度数据（包括重力）
            const acceleration = event.accelerationIncludingGravity;
            if (!acceleration) return;
            
            // 检测所有方向的加速度，因为不同设备坐标系可能不同
            const x = acceleration.x || 0;
            const y = acceleration.y || 0;
            const z = acceleration.z || 0;
            
            // 计算总加速度大小（去除重力影响）
            const totalAccel = Math.sqrt(x*x + y*y + z*z) - 9.8;
            
            // 显示调试信息
            debugDisplay.text = `加速度: ${totalAccel.toFixed(2)}\nx:${x.toFixed(1)} y:${y.toFixed(1)} z:${z.toFixed(1)}`;
            
            // 使用总加速度来检测动作
            if (totalAccel < -2 && !isLowPosition) {
                isLowPosition = true;
                isHighPosition = false;
                console.log("下蹲位置", totalAccel);
                
                // // 添加视觉反馈
                // new Circle({
                //     radius: 50,
                //     color: "#FFEB3B",
                //     alpha: 0.5
                // }).center(container).animate({
                //     props: {alpha:0, scale:1.2},
                //     time: 300,
                //     onComplete: function(tween) {
                //         tween.target.removeFrom();
                //     }
                // });
            }
            
            // 检测站立位置并计数
            if (totalAccel > 2 && isLowPosition && !isHighPosition) {
                isHighPosition = true;
                isLowPosition = false;
                repCount++;
                repCountDisplay.text = `次数: ${repCount}`;
                console.log("完成一次硬拉:", repCount, totalAccel);
                
                // // 添加视觉反馈
                // new Circle({
                //     radius: 120,
                //     color: "#4CAF50",
                //     alpha: 0.5
                // }).center(container).animate({
                //     props: {alpha:0, scale:1.5},
                //     time: 500,
                //     onComplete: function(tween) {
                //         tween.target.removeFrom();
                //     }
                // });
            }
            
            // 重置状态，为下一次动作做准备
            if (Math.abs(totalAccel) < 0.5) {
                isLowPosition = false;
                isHighPosition = false;
            }
            
            S.update();
        });
    }

    // 处理权限
    if (typeof DeviceOrientationEvent !== 'undefined' && 
        typeof DeviceOrientationEvent.requestPermission === 'function') {
        
        // 添加权限按钮
        const permissionButton = new Button({
            width: 200,
            height: 50,
            label: "开始训练",
            backgroundColor: blue,
            rollBackgroundColor: "#1976D2",
            corner: 10
        }).center(container);

        permissionButton.on("click", async () => {
            try {
                // 请求设备方向权限
                const orientationPermission = await DeviceOrientationEvent.requestPermission();
                
                // 请求设备运动权限（如果可用）
                let motionPermission = "granted";
                if (typeof DeviceMotionEvent !== 'undefined' && 
                    typeof DeviceMotionEvent.requestPermission === 'function') {
                    motionPermission = await DeviceMotionEvent.requestPermission();
                }
                
                if (orientationPermission === "granted" && motionPermission === "granted") {
                    setupTiltDetection();
                    permissionButton.removeFrom();
                }
            } catch (error) {
                console.error("Error requesting permission:", error);
            }
        });
    } else {
        setupTiltDetection();
    }

    S.update();
}
</script>

</head>
<body></body>
</html>